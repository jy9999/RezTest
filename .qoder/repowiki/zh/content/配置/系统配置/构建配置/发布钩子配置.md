# 发布钩子配置

<cite>
**本文档中引用的文件**  
- [release_hook.py](file://rez-3.3.0\src\rez\release_hook.py)
- [command.py](file://rez-3.3.0\src\rezplugins\release_hook\command.py)
- [emailer.py](file://rez-3.3.0\src\rezplugins\release_hook\emailer.py)
- [amqp.py](file://rez-3.3.0\src\rezplugins\release_hook\amqp.py)
- [config.py](file://rez-3.3.0\src\rez\config.py)
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py)
- [data_utils.py](file://rez-3.3.0\src\rez\utils\data_utils.py)
- [rezconfig.py](file://rez-3.3.0\src\rez\rezconfig.py)
- [emailer-recipients-example.yaml](file://rez-3.3.0\src\rezplugins\release_hook\emailer-recipients-example.yaml)
</cite>

## 目录
1. [发布钩子概述](#发布钩子概述)
2. [配置项使用方法](#配置项使用方法)
3. [ModifyList类的追加和前置操作](#modifylist类的追加和前置操作)
4. [内置钩子配置](#内置钩子配置)
5. [自定义钩子函数注册](#自定义钩子函数注册)
6. [钩子执行顺序与异常处理](#钩子执行顺序与异常处理)
7. [环境变量动态覆盖](#环境变量动态覆盖)
8. [配置文件示例与项目定制](#配置文件示例与项目定制)

## 发布钩子概述

发布钩子（release hooks）是Rez系统中用于在软件包发布过程中执行自定义行为的机制。通过发布钩子，可以在发布前、发布后等关键节点触发特定动作，如发送通知、执行脚本、更新服务发现等。发布钩子通过插件机制实现，支持多种内置钩子和自定义钩子。

**Section sources**
- [release_hook.py](file://rez-3.3.0\src\rez\release_hook.py#L37-L129)

## 配置项使用方法

`release_hooks` 配置项用于指定在发布过程中要执行的钩子列表。该配置项是一个字符串列表，每个字符串对应一个钩子插件的名称。配置项可以在全局配置文件或包定义文件中设置。

```python
release_hooks = ["emailer", "amqp", "command"]
```

当发布过程启动时，系统会根据配置项加载相应的钩子插件，并在适当的时机调用其方法。

**Section sources**
- [config.py](file://rez-3.3.0\src\rez\config.py#L379)
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L345-L347)

## ModifyList类的追加和前置操作

`ModifyList` 类用于对列表类型的配置项进行追加和前置操作。通过 `ModifyList`，可以在不覆盖原有配置的情况下，向列表中添加新元素。

```python
from rez.utils.data_utils import ModifyList

# 追加操作
c.release_hooks = ModifyList(append=["custom_release_notify"])

# 前置操作
c.release_hooks = ModifyList(prepend=["custom_release_notify"])
```

`ModifyList` 类支持 `append` 和 `prepend` 两个参数，分别用于指定要追加和前置的元素列表。

**Section sources**
- [data_utils.py](file://rez-3.3.0\src\rez\utils\data_utils.py#L16-L45)
- [config.py](file://rez-3.3.0\src\rez\config.py#L747)

## 内置钩子配置

### AMQP钩子

AMQP钩子用于在发布后向消息代理发送消息。配置项包括主机地址、用户ID、密码、交换机名称等。

```python
amqp = {
    "host": "localhost",
    "userid": "guest",
    "password": "guest",
    "exchange_name": "rez_exchange",
    "exchange_routing_key": "REZ.PACKAGE.RELEASED"
}
```

**Diagram sources**
- [amqp.py](file://rez-3.3.0\src\rezplugins\release_hook\amqp.py#L34-L42)

### Emailer钩子

Emailer钩子用于在发布后发送电子邮件通知。配置项包括SMTP主机、端口、发件人、收件人、主题和正文。

```python
emailer = {
    "smtp_host": "smtp.example.com",
    "smtp_port": 587,
    "sender": "noreply@example.com",
    "recipients": ["devs@example.com"],
    "subject": "[rez] [release] {system.user} released {package.qualified_name}",
    "body": """
Package '{package.qualified_name}' was released by {system.user}@{system.fqdn}.

USER: {system.user}
PACKAGE: {package.qualified_name}
RELEASED TO: {release.path}
PREVIOUS VERSION: {release.previous_version}
REZ VERSION: {system.rez_version}

{variants.count} VARIANTS:
{variants.paths}

MESSAGE:
{release.message}

CHANGELOG:
{release.changelog}
""".strip()
}
```

**Diagram sources**
- [emailer.py](file://rez-3.3.0\src\rezplugins\release_hook\emailer.py#L21-L52)

## 自定义钩子函数注册

要注册自定义钩子函数，需要创建一个继承自 `ReleaseHook` 的类，并实现 `name` 类方法和相应的钩子方法（如 `pre_build`、`pre_release`、`post_release`）。

```python
from rez.release_hook import ReleaseHook

class CustomReleaseHook(ReleaseHook):
    @classmethod
    def name(cls):
        return "custom"

    def post_release(self, user, install_path, variants, **kwargs):
        # 自定义发布后操作
        print(f"Custom hook executed for {self.package.qualified_name}")
```

然后在配置文件中添加自定义钩子：

```python
release_hooks = ["custom"]
```

**Section sources**
- [release_hook.py](file://rez-3.3.0\src\rez\release_hook.py#L37-L129)
- [emailer.py](file://rez-3.3.0\src\rezplugins\release_hook\emailer.py#L19-L32)

## 钩子执行顺序与异常处理

发布钩子按照配置项中指定的顺序依次执行。每个钩子方法在执行过程中如果抛出 `ReleaseHookCancellingError` 异常，发布过程将被取消。

```python
from rez.exceptions import ReleaseHookCancellingError

def pre_release(self, user, install_path, variants=None, **kwargs):
    if not self.check_conditions():
        raise ReleaseHookCancellingError("Pre-release conditions not met")
```

对于非取消异常，系统会记录错误信息并继续执行后续钩子。

**Section sources**
- [release_hook.py](file://rez-3.3.0\src\rez\release_hook.py#L79-L81)
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L355-L359)

## 环境变量动态覆盖

可以通过环境变量 `REZ_RELEASE_HOOKS` 动态覆盖配置文件中的 `release_hooks` 设置。环境变量的值应为逗号分隔的钩子名称列表。

```bash
export REZ_RELEASE_HOOKS="emailer,command"
```

当环境变量存在时，其值将覆盖配置文件中的设置。

**Section sources**
- [config.py](file://rez-3.3.0\src\rez\config.py#L379)
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L345-L347)

## 配置文件示例与项目定制

### 配置文件示例

```yaml
release_hooks: ["emailer", "amqp"]

plugins:
  release_hook:
    emailer:
      smtp_host: "smtp.example.com"
      sender: "noreply@example.com"
      recipients: ["devs@example.com"]
    amqp:
      host: "localhost"
      exchange_routing_key: "REZ.PACKAGE.RELEASED"
```

### 项目定制

可以通过包定义文件中的 `config` 属性为不同项目定制发布钩子。

```python
name = "my_project"
version = "1.0.0"

config = {
    "release_hooks": ["emailer"],
    "plugins": {
        "release_hook": {
            "emailer": {
                "recipients": ["project_devs@example.com"]
            }
        }
    }
}
```

**Section sources**
- [rezconfig.py](file://rez-3.3.0\src\rez\rezconfig.py#L788)
- [emailer-recipients-example.yaml](file://rez-3.3.0\src\rezplugins\release_hook\emailer-recipients-example.yaml#L30-L43)