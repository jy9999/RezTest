# 发布流程配置

<cite>
**本文档中引用的文件**  
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py)
- [release.py](file://rez-3.3.0\src\rez\cli\release.py)
- [release_vcs.py](file://rez-3.3.0\src\rez\release_vcs.py)
- [config.py](file://rez-3.3.0\src\rez\config.py)
- [git.py](file://rez-3.3.0\src\rezplugins\release_vcs\git.py)
- [svn.py](file://rez-3.3.0\src\rezplugins\release_vcs\svn.py)
- [test_config.py](file://rez-3.3.0\src\rez\tests\test_config.py)
- [package.py](file://rez-3.3.0\src\rez\data\tests\config\package.py)
- [test2.py](file://rez-3.3.0\src\rez\data\tests\config\test2.py)
- [environment.rst](file://rez-3.3.0\docs\source\environment.rst)
- [configuring_rez.rst](file://rez-3.3.0\docs\source\configuring_rez.rst)
</cite>

## 目录
1. [简介](#简介)
2. [发布路径配置](#发布路径配置)
3. [发布确认提示配置](#发布确认提示配置)
4. [版本控制系统集成](#版本控制系统集成)
5. [配置示例](#配置示例)
6. [版本号与标签命名规则](#版本号与标签命名规则)
7. [常见问题解决方案](#常见问题解决方案)

## 简介
Rez包管理系统提供了一套完整的发布流程配置机制，允许用户通过配置项精确控制包的发布行为。本文档详细介绍了`release_packages_path`、`prompt_release_message`和`release_vcs`等核心配置项的使用方法，以及如何通过这些配置项实现灵活的发布策略。

**Section sources**
- [config.py](file://rez-3.3.0\src\rez\config.py#L382)
- [configuring_rez.rst](file://rez-3.3.0\docs\source\configuring_rez.rst#L57-L86)

## 发布路径配置
`release_packages_path`配置项用于指定包发布的目标存储路径。该配置项允许用户为不同类型的包设置不同的发布位置，实现内部包和外部包的分离管理。

### 路径配置方法
通过在配置文件中设置`release_packages_path`，可以定义包的发布目标路径。该路径必须存在且可写，否则发布过程将失败。

```python
# 在配置文件中设置发布路径
release_packages_path = "/svr/packages/internal"
```

### 包级配置覆盖
包本身可以在其`package.py`文件中覆盖全局配置，实现特定包的发布路径定制。

```python
# 在package.py中使用scope覆盖配置
with scope("config") as c:
    c.release_packages_path = "/svr/packages/internal"
```

**Section sources**
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L281-L283)
- [configuring_rez.rst](file://rez-3.3.0\docs\source\configuring_rez.rst#L72-L75)

## 发布确认提示配置
`prompt_release_message`配置项控制是否在发布过程中提示用户输入发布消息。当设置为`True`时，系统会自动打开编辑器让用户输入发布说明。

### 提示机制
当`prompt_release_message`启用时，系统会创建一个临时文件并使用配置的编辑器打开，允许用户输入发布消息。该消息随后会被用作版本控制系统的提交信息。

```mermaid
flowchart TD
Start([开始发布流程]) --> CheckPrompt["检查prompt_release_message配置"]
CheckPrompt --> |True| CreateFile["创建临时消息文件"]
CreateFile --> OpenEditor["打开配置的编辑器"]
OpenEditor --> WaitForInput["等待用户输入"]
WaitForInput --> ReadMessage["读取用户输入的消息"]
ReadMessage --> UseMessage["将消息用于发布"]
CheckPrompt --> |False| SkipPrompt["跳过消息输入"]
SkipPrompt --> UseMessage
UseMessage --> End([完成发布准备])
```

**Diagram sources**
- [release.py](file://rez-3.3.0\src\rez\cli\release.py#L84-L114)
- [environment.rst](file://rez-3.3.0\docs\source\environment.rst#L238-L239)

**Section sources**
- [release.py](file://rez-3.3.0\src\rez\cli\release.py#L84-L138)
- [config.py](file://rez-3.3.0\src\rez\config.py#L790-L792)

## 版本控制系统集成
`release_vcs`配置项用于集成Git、SVN等版本控制系统，实现发布时自动创建标签和提交变更。

### 支持的VCS类型
Rez支持多种版本控制系统，包括：
- Git
- SVN
- Mercurial (hg)

### Git集成配置
Git集成通过`release_vcs.git`命名空间下的配置项进行控制，包括可发布分支、是否允许无上游分支等设置。

```mermaid
classDiagram
class ReleaseVCS {
+pkg_root : str
+vcs_root : str
+package : Package
+settings : dict
+validate_repostate()
+get_current_revision()
+get_changelog()
+tag_exists()
+create_release_tag()
+export()
}
class GitReleaseVCS {
+executable : str
+get_local_branch()
+get_tracking_branch()
+get_relative_to_remote()
}
class SvnReleaseVCS {
+svnc : Client
+this_url : str
+get_tag_url()
+svn_url_exists()
}
ReleaseVCS <|-- GitReleaseVCS
ReleaseVCS <|-- SvnReleaseVCS
GitReleaseVCS ..> "uses" git : Executable
SvnReleaseVCS ..> "uses" pysvn : Client
```

**Diagram sources**
- [release_vcs.py](file://rez-3.3.0\src\rez\release_vcs.py#L70-L231)
- [git.py](file://rez-3.3.0\src\rezplugins\release_vcs\git.py#L21-L242)
- [svn.py](file://rez-3.3.0\src\rezplugins\release_vcs\svn.py#L60-L139)

**Section sources**
- [release_vcs.py](file://rez-3.3.0\src\rez\release_vcs.py#L15-L67)
- [git.py](file://rez-3.3.0\src\rezplugins\release_vcs\git.py#L21-L143)
- [svn.py](file://rez-3.3.0\src\rezplugins\release_vcs\svn.py#L60-L94)

## 配置示例
以下配置示例展示了如何为内部包和外部包设置不同的发布策略。

### 内部包发布配置
```python
# internal_config.py
release_packages_path = "/svr/packages/internal"
prompt_release_message = True
release_hooks = ["emailer"]

plugins = {
    "release_vcs": {
        "tag_name": "{name}-{version}",
        "releasable_branches": ["main", "release/.*"]
    },
    "release_hook": {
        "emailer": {
            "sender": "{system.user}@company.com",
            "recipients": ["dev-team@company.com"]
        }
    }
}
```

### 外部包发布配置
```python
# external_config.py
release_packages_path = "/svr/packages/external"
prompt_release_message = False
release_hooks = ["amqp"]

plugins = {
    "release_vcs": {
        "tag_name": "v{version}",
        "check_tag": True
    },
    "release_hook": {
        "amqp": {
            "broker_url": "amqp://guest:guest@localhost:5672/"
        }
    }
}
```

### 包级配置覆盖示例
```python
# package.py - 特定包的配置覆盖
name = "myapp"
version = "1.0.0"

with scope("config") as c:
    # 覆盖发布路径
    c.release_packages_path = "/svr/packages/critical"
    
    # 添加额外的发布钩子
    c.release_hooks = ModifyList(append=["backup"])
    
    # 自定义VCS配置
    c.plugins = {
        "release_vcs": {
            "tag_name": "prod-{version}-{system.date:%Y%m%d}"
        }
    }
```

**Section sources**
- [package.py](file://rez-3.3.0\src\rez\data\tests\config\package.py#L13-L38)
- [test2.py](file://rez-3.3.0\src\rez\data\tests\config\test2.py#L1-L9)
- [test_config.py](file://rez-3.3.0\src\rez\tests\test_config.py#L153-L162)

## 版本号与标签命名规则
Rez系统提供了灵活的版本号生成和标签命名配置机制，允许用户根据项目需求自定义命名约定。

### 标签命名配置
通过`plugins.release_vcs.tag_name`配置项，可以定义标签的命名模板。模板支持变量替换，包括包名、版本号和系统信息。

```python
# 标签命名配置示例
plugins = {
    "release_vcs": {
        "tag_name": "{name}-v{version}-{system.user}"
    }
}
```

### 变量替换规则
标签命名模板支持以下变量替换：
- `{name}`: 包名称
- `{version}`: 包版本号
- `{system.user}`: 当前用户
- `{system.date}`: 当前日期
- `{system.platform}`: 当前平台

### 版本号验证
发布过程中会自动验证版本号的合理性，确保新版本号大于已发布的版本号（除非明确允许发布旧版本）。

```mermaid
sequenceDiagram
participant User as 用户
participant Rez as Rez系统
participant VCS as 版本控制系统
participant Storage as 存储系统
User->>Rez : 执行发布命令
Rez->>Rez : 验证发布路径可写
Rez->>VCS : 检查仓库状态
VCS-->>Rez : 返回状态信息
Rez->>Rez : 验证版本号是否最新
Rez->>Rez : 生成标签名称
Rez->>User : 提示输入发布消息(如配置)
User->>Rez : 提交发布消息
Rez->>Storage : 执行包构建和发布
Rez->>VCS : 创建版本标签
VCS-->>Rez : 返回标签创建结果
Rez->>User : 显示发布结果
```

**Diagram sources**
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L336-L343)
- [release.py](file://rez-3.3.0\src\rez\cli\release.py#L70-L78)

**Section sources**
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L316-L323)
- [release_vcs.py](file://rez-3.3.0\src\rez\release_vcs.py#L337-L342)

## 常见问题解决方案
### 发布路径不可写
当发布路径不可写时，系统会抛出`ReleaseError`异常。解决方案包括：

1. **检查路径权限**：确保发布路径存在且当前用户有写权限
2. **创建路径**：如果路径不存在，先创建目录
3. **修改配置**：将发布路径改为有写权限的目录

```bash
# 解决方案示例
mkdir -p /svr/packages/internal
chmod 755 /svr/packages/internal
```

### VCS认证失败
VCS认证失败通常发生在Git或SVN操作时。解决方案包括：

1. **Git SSH密钥配置**：确保SSH密钥已正确配置
2. **Git凭证存储**：使用Git凭证助手存储密码
3. **SVN认证缓存**：配置SVN客户端缓存认证信息

对于SVN，系统提供了交互式密码输入机制：

```python
def get_svn_login(realm, username, may_save):
    """
    提供SVN权限信息
    """
    import getpass
    print(f"svn requires a password for the user {username}:")
    pwd = ''
    while not pwd.strip():
        pwd = getpass.getpass("--> ")
    return True, username, pwd, False
```

### 标签已存在
当尝试发布已存在的版本时，系统会阻止发布以防止冲突。解决方案包括：

1. **增加版本号**：发布更高版本
2. **使用忽略选项**：使用`--ignore-existing-tag`参数强制发布
3. **删除现有标签**：如果确实需要覆盖，先删除现有标签

```bash
# 使用忽略选项发布
rez-release --ignore-existing-tag
```

**Section sources**
- [build_process.py](file://rez-3.3.0\src\rez\build_process.py#L292-L303)
- [svn.py](file://rez-3.3.0\src\rezplugins\release_vcs\svn.py#L45-L57)
- [git.py](file://rez-3.3.0\src\rezplugins\release_vcs\git.py#L100-L106)