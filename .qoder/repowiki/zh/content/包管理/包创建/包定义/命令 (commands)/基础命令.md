# 基础命令

<cite>
**本文档中引用的文件**  
- [myapp\1.0.0\package.py](file://my_packages/myapp/1.0.0/package.py)
- [hello_world\package.py](file://rez-3.3.3.0/example_packages/hello_world/package.py)
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst)
- [package_definition.rst](file://rez-3.3.0/docs/source/package_definition.rst)
- [rex.py](file://rez-3.3.0/src/rez/rex.py)
</cite>

## 目录
1. [简介](#简介)
2. [commands函数的作用与执行时机](#commands函数的作用与执行时机)
3. [环境变量配置机制](#环境变量配置机制)
4. [env对象的使用方法](#env对象的使用方法)
5. [{root}变量的替换机制](#root变量的替换机制)
6. [实际示例分析](#实际示例分析)
7. [路径添加与工具定义](#路径添加与工具定义)
8. [命令执行顺序](#命令执行顺序)
9. [总结](#总结)

## 简介
`commands`函数是Rez包管理系统中用于定义环境配置的核心机制。当一个包被激活时，其`commands`函数会在环境解析过程中执行，负责设置必要的环境变量、路径和工具，从而使该包能够在当前环境中正常运行。本文将详细解释`commands`函数的工作原理，并通过`myapp`和`hello_world`两个示例说明如何使用`env`对象和`{root}`变量来配置环境。

## commands函数的作用与执行时机
`commands`函数在包被激活时执行，主要用于配置环境以使包可用。它是一个Python函数，定义在每个包的`package.py`文件中。当用户通过`rez-env`等命令请求某个包时，Rez会解析依赖关系并按特定顺序执行所有相关包的`commands`函数。

这些函数使用Rez的`rex`（Rez Execution Language）API来执行shell操作，如设置环境变量、追加路径、创建别名等。最终，这些操作会被转换为目标shell（如bash、zsh等）的代码并执行，从而完成环境的配置。

**Section sources**
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst#L5-L23)
- [package_definition.rst](file://rez-3.3.0/docs/source/package_definition.rst#L653-L674)

## 环境变量配置机制
`commands`函数的核心功能之一是配置环境变量。Rez提供了多种方式来操作环境变量，包括设置、追加、前置等。对于路径类环境变量（如`PATH`、`PYTHONPATH`），首次操作会覆盖原有值，后续操作才会进行追加或前置。

这种设计是为了避免系统中已存在的模块干扰新环境的配置。例如，如果系统Python路径已在`PYTHONPATH`中，而用户希望通过Rez切换到另一个版本的Python，则首次`append`操作会清空原有路径，确保新环境的纯净性。

**Section sources**
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst#L74-L87)
- [rex.py](file://rez-3.3.0/src/rez/rex.py#L297-L309)

## env对象的使用方法
`env`对象是`commands`函数中最常用的工具，代表了即将被配置的环境字典。通过`env`对象，可以方便地访问和修改环境变量。

### 设置环境变量
使用`env`对象可以直接设置环境变量：
```python
env.MYAPP_ROOT = "{root}"
```

### 路径追加与前置
对于路径类变量，可以使用`append`和`prepend`方法：
```python
env.PATH.append("{root}/bin")
env.PYTHONPATH.append("{root}/lib")
```
这些操作会自动处理不同平台的路径分隔符问题，确保跨平台兼容性。

**Section sources**
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst#L431-L465)
- [myapp\1.0.0\package.py](file://my_packages/myapp/1.0.0/package.py#L20-L22)

## {root}变量的替换机制
`{root}`是一个特殊的占位符，表示当前包的安装目录。在`commands`函数执行时，所有出现的`{root}`都会被替换为实际的安装路径。

除了`{root}`，还可以使用`{this.root}`，两者效果相同。此外，`this`对象还提供了其他有用的属性，如`this.name`（包名）、`this.version`（版本号）等，可用于更复杂的路径构造。

字符串扩展功能仅在传递给`rex`函数或`env`对象时生效。如果需要在普通变量赋值中展开，必须使用`expandvars`函数：
```python
var = expandvars("{root}/bin")
```

**Section sources**
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst#L104-L171)
- [package_definition.rst](file://rez-3.3.0/docs/source/package_definition.rst#L754-L758)

## 实际示例分析
### myapp示例
`myapp`包的`package.py`文件展示了典型的`commands`函数用法：
```python
def commands():
    import os
    env.MYAPP_ROOT = "{root}"
    env.PATH.append("{root}/bin")
    env.PYTHONPATH.append("{root}/lib")
```
该函数设置了`MYAPP_ROOT`环境变量，并将`bin`和`lib`目录添加到`PATH`和`PYTHONPATH`中，使得应用程序及其Python模块可以被正确找到。

### hello_world示例
`hello_world`包的`commands`函数更为简洁：
```python
def commands():
    env.PYTHONPATH.append("{root}/python")
    env.PATH.append("{root}/bin")
```
它仅需配置Python模块路径和可执行文件路径，体现了`commands`函数的灵活性和简洁性。

**Section sources**
- [myapp\1.0.0\package.py](file://my_packages/myapp/1.0.0/package.py#L17-L23)
- [hello_world\package.py](file://rez-3.3.0/example_packages/hello_world/package.py#L26-L28)

## 路径添加与工具定义
在`commands`函数中，通常需要将包的`bin`目录添加到`PATH`，以便用户可以直接调用其中的可执行文件。同时，如果是Python包，还需要将`python`目录添加到`PYTHONPATH`。

此外，包的`tools`属性可以显式列出提供的工具，这有助于Rez进行更精确的依赖管理和环境配置：
```python
tools = ["hello"]
```

**Section sources**
- [hello_world\package.py](file://rez-3.3.0/example_packages/hello_world/package.py#L14-L16)
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst#L74-L79)

## 命令执行顺序
包命令的执行顺序由两个因素决定：包的请求顺序和依赖关系。基本原则如下：
- 如果包A在包B之前被请求，则A的命令先于B执行；
- 但如果包A依赖于包B，则B的命令会先执行，以确保依赖环境已正确设置。

例如，若`maya_anim_tool`依赖于`maya`，则`maya`的`commands`会先执行，初始化`MAYA_PLUG_IN_PATH`等环境变量，然后`maya_anim_tool`再追加自己的插件路径。

**Section sources**
- [package_commands.rst](file://rez-3.3.0/docs/source/package_commands.rst#L40-L54)
- [package_definition.rst](file://rez-3.3.0/docs/source/package_definition.rst#L653-L674)

## 总结
`commands`函数是Rez包管理系统中实现环境隔离和依赖管理的关键组件。通过合理使用`env`对象和`{root}`变量，开发者可以轻松地配置复杂的软件环境。理解`commands`函数的执行时机、环境变量操作机制以及命令执行顺序，对于构建可靠、可维护的包至关重要。